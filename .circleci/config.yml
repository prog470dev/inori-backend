# Golang CircleCI 2.0 configuration file
#
# Check https://circleci.com/docs/2.0/language-go/ for more details
version: 2
jobs:
  build:
    docker:
      # specify the version
      - image: circleci/golang:1.9
      - image: circleci/mysql:5.7
        command: mysqld --character-set-server=utf8mb4 --collation-server=utf8mb4_bin --innodb-large-prefix=true --innodb-file-format=Barracuda
        environment:
          MYSQL_USER: root
          MYSQL_ROOT_PASSWORD: circleci
          MYSQL_ALLOW_EMPTY_PASSWORD: true

    working_directory: /go/src/github.com/prog470dev/inori-backend
    steps:
      - checkout

      # specify any bash command here prefixed with `run: `
      - run: go get -v -t -d ./...
      - run: go test -v ./...
      - add_ssh_keys:
          fingerprints:
            - "60:1d:96:93:28:03:f0:9f:9a:3c:e7:35:37:94:a6:71"
      - run:
          name: ssh-key
          command: echo ${SSH_KEY} >> ~/.ssh/known_hosts
      - run: GOOS=linux GOARCH=amd64 go build -o ino.out
      - run: mkdir Ino
      #- run: chmod 777 dbconfig.yml && chmod -R 777 migrations && chmod 777 ino.out
      - run: cp dbconfig.yml Ino && cp -r migrations Ino && cp ino.out Ino
#      - run: chmod -R 777 Ino
#      - run: scp -o "StrictHostKeyChecking=no" Ino/dbconfig.yml tshimizu@118.27.33.104:./
      - run: cd Ino
      - run: rsync -avz --delete . tshimizu@118.27.33.104:./Ino
#      - run: scp -o "StrictHostKeyChecking=no" -r Ino/ tshimizu@118.27.33.104:./
      - run: scp -o "StrictHostKeyChecking=no" .circleci/deploy.sh tshimizu@118.27.33.104:./
      - run: ssh -o "StrictHostKeyChecking=no" tshimizu@118.27.33.104 ./deploy.sh

